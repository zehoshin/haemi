<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- <script src="https://launchar.app/sdk/v1?key=W32qZHWl1TisDhJtIIeZhT7arhbVhF4s&redirect=true"></script> -->
		<title>arTest</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<!-- <link type="text/css" rel="stylesheet" href="style.css"> -->
	</head>
	<body>
        <div class="title">play AR on mobile device<br>04221050</div>
		<div id="onAR"></div>
		<div id="webcam-container"></div>

		<script type="importmap">
			{
				"imports": {
					"three": "./src/jsm/three.module.js",
					"three/addons/": "./src/jsm/"
				}
				
			}
		</script>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
		<script type="module" src="script.js"></script>
		<script type="text/javascript">
const URL = "./my_model/";
let model, webcam, onAR, maxPredictions, frameID;

async function init() {
	const modelURL = URL + "model.json";
	const metadataURL = URL + "metadata.json";
	model = await tmImage.load(modelURL, metadataURL);
	maxPredictions = model.getTotalClasses();
	webcam = new tmImage.Webcam(200, 200, false);

	await webcam.setup({
		facingMode: 'environment',
	});
	
	await webcam.play();
	window.requestAnimationFrame(loop);
	document.getElementById("webcam-container").appendChild(webcam.canvas);
	onAR = document.getElementById("onAR");
	for (let i = 0; i < maxPredictions; i++) {
		onAR.appendChild(document.createElement("div"));
	}
}

async function loop() {
	if (webcam !== null) {
		webcam.update();
		await predict();
		frameID = window.requestAnimationFrame(loop);
	} else {
		console.log('Loop stopped');
	}
}

async function predict() {
	const prediction = await model.predict(webcam.canvas);
	for (let i = 0; i < maxPredictions; i++) {
		const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
		console.log(classPrediction)
		onAR.childNodes[i].innerHTML = classPrediction;
	}
}

function setupEventListeners() {
	document.getElementById('ARButton').addEventListener('click', async function() {
		await webcam.stop();
		window.cancelAnimationFrame(frameID);
		document.getElementById("webcam-container").removeChild(webcam.canvas);
		webcam = null;
		console.log('Webcam stopped');
	});

	document.querySelector('svg').addEventListener('click', async function() {
		webcam = new tmImage.Webcam(200, 200, false);
		await webcam.setup({ facingMode: 'environment' });
		await webcam.play();
		document.getElementById("webcam-container").appendChild(webcam.canvas);
		loop();
		console.log('Webcam started');
	});
}

document.addEventListener("DOMContentLoaded", function() {
	init().then(setupEventListeners); 
});

		</script>
	</body>
</html>